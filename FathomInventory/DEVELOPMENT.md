# Development Guide - START HERE

**🚨 If you're making changes to this project, follow this checklist.**

> **🆘 Lost context?** Read [CONTEXT_RECOVERY.md](CONTEXT_RECOVERY.md) to understand current state and how to resume work.

## Quick Start for AI Assistants / New Developers

```bash
# 1. Test before changing anything
python run_daily_share.py --use-db
cd authentication && python test_fathom_cookies.py

# 2. Make changes, then test again
# 3. Use PR workflow (see below)
```

---

## Critical Constraints

### 🚫 NEVER Touch These Directly
- `main` branch (protected - use PRs)
- Cookie files (gitignored - manual refresh only)
- Database file (gitignored - generated by system)
- Files in `/backups/` (historical only)

### ⚠️ Known Issues
- **Dropbox file locking**: Daemon processes (launchd) can't reliably access Dropbox files
  - Logs moved to `/Users/admin/Library/Logs/` to fix this
  - venv still in Dropbox (causes warnings but works when run manually)
  - **Solution**: Move entire project out of Dropbox if automation breaks

---

## Making Changes: PR Workflow

### 1. Before You Start
```bash
# Verify system is working
cd authentication && python test_fathom_cookies.py
# Should show: "✅ OK"
```

### 2. Make Changes
```bash
# Create branch
git checkout -b fix-description

# Edit files
# ...

# Test your changes
python run_daily_share.py --use-db
# Should complete without errors
```

### 3. Commit & PR
```bash
# Check what's changed
git status

# Verify no secrets exposed
git ls-files | grep -E "cookie|token|credential|\.db"
# Should only show tool files, not actual secrets

# Commit
git add [files]
git commit -m "Brief description"

# Push and create PR
git push origin fix-description
gh pr create --title "Fix: description"
```

### 4. After Merge
```bash
# Update local
git checkout main
git pull origin main
```

---

## Testing Checklist

### Minimum Before Committing
- [ ] `python run_daily_share.py --use-db` completes successfully
- [ ] `cd authentication && python test_fathom_cookies.py` shows ✅
- [ ] No secrets in git: `git status` shows no `.json` or `.db` files staged

### After Deploying Changes
- [ ] Check automation ran: `tail /Users/admin/Library/Logs/fathom_cron.log`
- [ ] Check launchd status: `launchctl list | grep fathom`
- [ ] Verify database updated: `sqlite3 fathom_emails.db "SELECT COUNT(*) FROM calls;"`
- [ ] **Check daily email**: Look for email from jschull@gmail.com with summary

---

## Troubleshooting

> **📋 Failure Detection**: The system now includes enhanced failure detection (Oct 17, 2025).  
> See [FAILURE_DETECTION_IMPROVEMENTS.md](docs/FAILURE_DETECTION_IMPROVEMENTS.md) for details.

### Authentication Fails
**Symptom**: "❌ AUTHENTICATION FAILED" or "Redirected to login page"  
**Fix**: Refresh cookies (weekly maintenance required)
```bash
./scripts/refresh_fathom_auth.sh
```

**Note**: Since Oct 17, 2025, authentication failures are detected immediately via pre-flight checks.

### Automation Not Running
**Symptom**: No log entries at 10 AM, launchd shows error code  
**Check**: `launchctl list | grep fathom`  
**Common causes**:
- Dropbox file locking (error code 11)
- Cookie expired (script runs but finds no new calls)
- Mac was asleep at 10 AM

**Fix**: See `docs/AUTOMATION_MONITORING_GUIDE.md`

### "Resource deadlock avoided"
**Cause**: Launchd trying to access Dropbox-synced files  
**Temporary fix**: Run manually `./run_all.sh`  
**Permanent fix**: Move project out of Dropbox

---

## Project Structure (What Goes Where)

```
FathomInventory/
├── DEVELOPMENT.md          ← YOU ARE HERE
├── README.md              ← User-facing instructions
├── PROJECT_STATUS.md      ← Current state, lessons learned
│
├── run_all.sh             ← Main automation script
├── run_daily_share.py     ← Core scraper
│
├── scripts/               ← Utility scripts
│   ├── refresh_fathom_auth.sh    ← Cookie refresh
│   ├── download_emails.py        ← Email fetcher
│   └── ...
│
├── authentication/        ← Auth tests
├── docs/                  ← Detailed documentation
│   ├── AUTOMATION_MONITORING_GUIDE.md
│   ├── AUTHENTICATION_GUIDE.md
│   └── TECHNICAL_DOCUMENTATION.md
│
└── (gitignored)/
    ├── fathom_cookies*.json     ← Secrets
    ├── token.json               ← Gmail OAuth
    ├── credentials.json         ← Google API
    └── fathom_emails.db         ← Data
```

---

## Multi-Account Setup (ERA vs e-NABLE)

**Current state**: Two Fathom accounts managed via centralized config
- `fathom_cookies_era.json` → ecorestorationalliance@gmail.com
- `fathom_cookies_enable.json` → jschull@e-nable.org (currently active)
- Configuration: `../era_config.py` (FATHOM_ACTIVE_ACCOUNT)

**Switching accounts:**
```bash
# Temporary switch via environment variable
FATHOM_ACCOUNT=era python run_daily_share.py

# Permanent switch - edit ../era_config.py
FATHOM_ACTIVE_ACCOUNT = 'era'  # Change from 'enable'
```

**Benefits of centralized config:**
- No more symlink confusion
- Single source of truth for account settings
- Clear, documented switching mechanism
- Environment variable support for testing

**Consolidation pending**: See `ACCOUNT_CONSOLIDATION_PREP.md`

---

## When to Read Detailed Docs

- **First time setup**: `README.md`
- **Authentication issues**: `docs/AUTHENTICATION_GUIDE.md`
- **Automation broken**: `docs/AUTOMATION_MONITORING_GUIDE.md`
- **Understanding architecture**: `docs/TECHNICAL_DOCUMENTATION.md`
- **System status**: `PROJECT_STATUS.md`

---

## Philosophy

- **Minimal documentation**: Only what's actionable
- **Test before commit**: Always
- **PR workflow**: Keeps history clean
- **Weekly maintenance**: Cookie refresh is required
- **Dropbox is problematic**: Known limitation for automation
